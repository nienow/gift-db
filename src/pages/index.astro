---
import Layout from "../layouts/Layout.astro";
import categories from "../data/categories.json";
import Card from "../components/Card.astro";
import Category from "../components/Category.astro";
---
<Layout title="Kickstarter projects">
    <div id="categories">
        <!--<button data-cat="all">All</button>-->
      {
        categories.map(c => (
                <div class="category">
                    <div class="category-name">{c.name}</div>
                  {
                    c.sub?.map((s, index) => (
                           <> {index > 0 && <>/</>} <button class="category-child" data-cat={c.name} data-cat2={s}>{s}</button></>
                    ))
                  }
                </div>
        ))
      }
    </div>
    <div id="cards" class="card-list"></div>
</Layout>
<Card/>
<Category/>
<script>
  let projects = [];
      let index = 0;
      const pageSize = 12;

      function renderProjects() {

          const cards = document.querySelector('#cards');
          projects.slice(index, index + pageSize).forEach(p => {
              const card = document.createElement('my-card');
              card.setAttribute('name', p.name);
              card.setAttribute('blurb', p.blurb);
              card.setAttribute('img', p.imgs.med);
              card.setAttribute('url', p.url);
              card.setAttribute('date', p.funded);
              cards.appendChild(card);
              });
          
          index += pageSize;
          }

      const btns = document.querySelectorAll('button[data-cat]');
      btns.forEach(btn => {

        btn.addEventListener('click', (e) => {
          const cat = e.target.dataset.cat;
          const cat2 = e.target.dataset.cat2;
          document.querySelector('#categories').remove();
          fetch(`/${cat}/${cat2}.json`)
              .then(res => res.json())
              .then(data => {
                projects = data.sort(() => Math.random() - 0.5);
                renderProjects();
                renderProjects();
              });
        });
      });


      window.addEventListener('scroll', () => {
          const { scrollTop, scrollHeight, clientHeight } = document.documentElement;

          if(clientHeight + scrollTop >= scrollHeight - 50) {
              renderProjects();
              }
          });
</script>

<style>
    .project {
        display: flex;
        margin-bottom: 20px;
    }

    img {
        margin-right: 20px;
    }

    .info {
        flex: 1;
    }
</style>
